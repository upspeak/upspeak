# `ui` Module

## Goals

The `ui` module provides the web frontend for Upspeak. Its primary aims are:

1. **Single Binary Deployment**: Embed the frontend assets directly into the Go binary for simplified deployment.
2. **Modern Web Stack**: Use SvelteKit with TypeScript for a reactive, type-safe frontend.
3. **SPA Support**: Enable client-side routing for seamless navigation without page reloads.
4. **Developer Experience**: Support hot-reload development workflow while maintaining production-ready builds.

## Important note

1. This module is tailored for Upspeak. The embedding pattern and structure are specific to this project's needs.
2. The frontend is built as a static SPA (Single Page Application) using `@sveltejs/adapter-static`.
3. The module is mounted at the root path (`/`) to provide clean URLs for the web interface.

## How the Go Module Packages SvelteKit

The `ui` module uses Go's `embed` package to bundle the SvelteKit application into the Go binary at compile time.

### Embedding Directives

```go
//go:embed web/build/*
var buildFS embed.FS

//go:embed web/static/*
var staticFS embed.FS
```

These directives:
- Embed all files from `web/build/` (SvelteKit's production build output)
- Embed all files from `web/static/` (static assets like favicon, robots.txt)
- Create in-memory filesystems accessible at runtime

### Serving Strategy

The module registers HTTP handlers to serve embedded assets:

1. **SvelteKit Assets** (`/_app/*`): JavaScript, CSS, and other bundled assets generated by the build process
   ```go
   buildFs, _ := fs.Sub(buildFS, "web/build")
   buildFileServer := http.FileServer(http.FS(buildFs))
   ```

2. **Static Files**: Individual files from `web/static/` (e.g., `/favicon.ico`)
   ```go
   data, _ := staticFS.ReadFile("web/static/favicon.png")
   ```

3. **SPA Fallback** (`/`): All unmatched routes serve `index.html` for client-side routing
   ```go
   data, _ := buildFS.ReadFile("web/build/index.html")
   ```

### Build Process

When building the Go binary:

1. Frontend assets must be built first: `cd ui/web && npm run build`
2. SvelteKit generates static files to `ui/web/build/`
3. Go's compiler embeds these files via `//go:embed` directives
4. The resulting binary contains the complete frontend

The embedded filesystem is read-only and accessed directly from the binary without extracting files to disk.

## Running the Svelte Dev Server

For frontend development with hot reload:

```bash
cd ui/web
npm install  # First time only
npm run dev
```

This starts Vite's development server at `http://localhost:5173` with:
- Hot Module Replacement (HMR) - changes appear instantly
- Source maps for debugging
- Fast rebuild times

### API Integration During Development

The dev server runs independently from the Go backend. To integrate with backend APIs:

**Option 1: Configure Vite proxy** (recommended)

Edit `ui/web/vite.config.ts`:

```typescript
export default defineConfig({
  server: {
    proxy: {
      '/api': 'http://localhost:8080'
    }
  }
});
```

**Option 2: Run backend separately**

```bash
# Terminal 1: Backend
go run main.go

# Terminal 2: Frontend
cd ui/web && npm run dev
```

Access frontend at `http://localhost:5173`, which proxies API calls to `http://localhost:8080`.

### Testing with Embedded Build

To test the production build served by Go:

```bash
# Build frontend
cd ui/web
npm run build

# Run Go binary
cd ../..
go run main.go

# Access at http://localhost:8080
```

## Adding a New Route

SvelteKit uses file-based routing. Routes are defined by the file structure in `ui/web/src/routes/`.

### Creating a Page

Create a `+page.svelte` file in the desired route directory:

```
ui/web/src/routes/
├── +page.svelte              # / (homepage)
├── about/
│   └── +page.svelte          # /about
└── settings/
    ├── +page.svelte          # /settings
    └── profile/
        └── +page.svelte      # /settings/profile
```

### Example: Adding `/about` Route

Create `ui/web/src/routes/about/+page.svelte`:

```svelte
<script lang="ts">
  let title = "About Upspeak";
</script>

<h1>{title}</h1>
<p>Upspeak is a personal knowledge management system.</p>

<style>
  h1 {
    color: #333;
  }
</style>
```

The route is automatically available at `/about` - no routing configuration needed.

### Dynamic Routes

Use square brackets for dynamic segments:

```
ui/web/src/routes/
└── threads/
    └── [id]/
        └── +page.svelte      # /threads/:id
```

Access the parameter in the component:

```svelte
<script lang="ts">
  import { page } from '$app/stores';

  let threadId = $page.params.id;
</script>

<h1>Thread {threadId}</h1>
```

### Route with Data Loading

Create `+page.ts` alongside `+page.svelte` for data loading:

```typescript
// ui/web/src/routes/threads/+page.ts
export async function load({ fetch }) {
  const response = await fetch('/api/threads');
  const threads = await response.json();

  return { threads };
}
```

```svelte
<!-- ui/web/src/routes/threads/+page.svelte -->
<script lang="ts">
  let { data } = $props();
</script>

<h1>Threads</h1>
{#each data.threads as thread}
  <div>{thread.title}</div>
{/each}
```

After adding routes, rebuild the frontend for production:

```bash
cd ui/web
npm run build
```

## Adding Static Assets

Static assets are files served directly without processing (images, fonts, documents).

### Adding to `web/static/`

Place files in `ui/web/static/`:

```
ui/web/static/
├── favicon.png
├── robots.txt
├── logo.svg
└── documents/
    └── guide.pdf
```

These files are:
1. Copied to `ui/web/build/` during SvelteKit build
2. Embedded into the Go binary via `//go:embed web/static/*`
3. Served at the root path

Access in your app:

```svelte
<!-- References /logo.svg -->
<img src="/logo.svg" alt="Logo" />

<!-- References /documents/guide.pdf -->
<a href="/documents/guide.pdf">Download Guide</a>
```

### Serving Custom Static Files from Go

For static files that need special handling, add HTTP handlers in `ui.go`:

```go
{
  Method: "GET",
  Path:   "/custom-asset.txt",
  Handler: func(w http.ResponseWriter, r *http.Request) {
    data, err := staticFS.ReadFile("web/static/custom-asset.txt")
    if err != nil {
      http.NotFound(w, r)
      return
    }
    w.Header().Set("Content-Type", "text/plain")
    w.Write(data)
  },
}
```

### Build Process for Static Assets

When you run `npm run build`:

1. SvelteKit copies files from `web/static/` → `web/build/`
2. Go embeds `web/build/*` and `web/static/*`
3. Files are served from the embedded filesystem

**Note**: Always rebuild both frontend and backend after adding static assets:

```bash
cd ui/web && npm run build && cd ../.. && go build -o bin/upspeak
```

## Configuration

The SvelteKit adapter is configured in `ui/web/svelte.config.js`:

```javascript
import adapter from '@sveltejs/adapter-static';

const config = {
  kit: {
    adapter: adapter({
      pages: resolve(__dirname, 'build'),
      assets: resolve(__dirname, 'build'),
      fallback: 'index.html',  // Enables SPA mode
      precompress: false,
      strict: true
    })
  }
};
```

Key settings:
- `fallback: 'index.html'` - Serves index.html for all unmatched routes (enables client-side routing)
- `pages` and `assets` - Both point to `build/` directory
- `strict: true` - Enforces explicit prerendering configuration

## License

This module is part of the Upspeak project and follows its licensing terms.
